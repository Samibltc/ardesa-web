---
deployment:
  tasks:
    # Ensure production mode and Node is on PATH (try common EA NodeJS paths)
    - export NODE_ENV=production
    - export PATH="/opt/cpanel/ea-nodejs20/bin:/opt/cpanel/ea-nodejs18/bin:/opt/cpanel/ea-nodejs16/bin:$PATH"

    # Log versions for debugging in cPanel deploy output
    - echo "Node: $(node -v) | npm: $(npm -v)"

    # Install dependencies and build Next.js
    - npm ci || npm install
    - npm run build

    # Prepare Passenger (Phusion) config to serve the app from this repo dir
    - export REPO_PATH="$(pwd)"
    # Common docroots: primary domain often public_html; some hosts use ~/DOMAIN
    - export DOCROOT1="$HOME/ardesasoftware.com"
    - export DOCROOT2="$HOME/public_html"

    # Restart Passenger after each deploy
    - mkdir -p "$REPO_PATH/tmp"
    - touch "$REPO_PATH/tmp/restart.txt"

    # Write .htaccess into any existing docroot(s)
    - |
      for D in "$DOCROOT1" "$DOCROOT2"; do
        if [ -d "$D" ]; then
          mkdir -p "$D"
          cat > "$D/.htaccess" <<EOF
      PassengerEnabled on
      PassengerAppType node
      PassengerAppRoot $REPO_PATH
      PassengerStartupFile server.js
      PassengerAppEnv production
      # If your server requires an explicit Node path, uncomment and adjust:
      # PassengerNodejs /opt/cpanel/ea-nodejs18/bin/node
      EOF
          echo "Wrote Passenger .htaccess to $D"
        fi
      done

    - echo "Deployment completed. AppRoot: $REPO_PATH"
